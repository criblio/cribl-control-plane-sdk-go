name: Update GH Action

on:
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Custom commit message (optional)'
        required: false
        default: 'chore: update speakeasy-api/sdk-generation-action to latest'

jobs:
  update-gh-action:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Get latest sdk-generation-action release
        id: latest-release
        run: |
          set -euo pipefail
          
          MAX_ATTEMPTS=5
          attempt=1
          TAG_NAME=""
          
          echo "Fetching latest release from speakeasy-api/sdk-generation-action..."
          
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "Attempt $attempt/$MAX_ATTEMPTS: Fetching latest release..."
            
            RELEASE_DATA=$(curl -s https://api.github.com/repos/speakeasy-api/sdk-generation-action/releases/latest)
            TAG_NAME=$(echo "$RELEASE_DATA" | jq -r '.tag_name')
            
            if [ "$TAG_NAME" != "null" ] && [ -n "$TAG_NAME" ]; then
              echo "âœ… Found latest release tag: $TAG_NAME"
              break
            fi
            
            if [ $attempt -lt $MAX_ATTEMPTS ]; then
              echo "âš ï¸ Could not fetch release tag (attempt $attempt/$MAX_ATTEMPTS), retrying in 2s..."
              sleep 2
              attempt=$((attempt + 1))
            else
              echo "âŒ Error: Could not fetch latest release tag after $MAX_ATTEMPTS attempts"
              exit 1
            fi
          done
          
          attempt=1
          COMMIT_SHA=""
          
          while [ $attempt -le $MAX_ATTEMPTS ]; do
            echo "Attempt $attempt/$MAX_ATTEMPTS: Resolving commit SHA for tag $TAG_NAME..."
            
            COMMIT_SHA=$(curl -s "https://api.github.com/repos/speakeasy-api/sdk-generation-action/git/refs/tags/${TAG_NAME}" | jq -r '.object.sha')
            
            if [ "$COMMIT_SHA" = "null" ] || [ -z "$COMMIT_SHA" ]; then
              TAG_OBJECT=$(curl -s "https://api.github.com/repos/speakeasy-api/sdk-generation-action/git/refs/tags/${TAG_NAME}" | jq -r '.object')
              OBJECT_TYPE=$(echo "$TAG_OBJECT" | jq -r '.type // empty')
              OBJECT_SHA=$(echo "$TAG_OBJECT" | jq -r '.sha // empty')
              
              if [ "$OBJECT_TYPE" = "tag" ]; then
                COMMIT_SHA=$(curl -s "https://api.github.com/repos/speakeasy-api/sdk-generation-action/git/tags/${OBJECT_SHA}" | jq -r '.object.sha')
              fi
            fi
            
            if [ "$COMMIT_SHA" != "null" ] && [ -n "$COMMIT_SHA" ]; then
              echo "âœ… Resolved commit SHA: $COMMIT_SHA"
              break
            fi
            
            if [ $attempt -lt $MAX_ATTEMPTS ]; then
              echo "âš ï¸ Could not resolve commit SHA (attempt $attempt/$MAX_ATTEMPTS), retrying in 2s..."
              sleep 2
              attempt=$((attempt + 1))
            else
              echo "âŒ Error: Could not resolve commit SHA for tag $TAG_NAME after $MAX_ATTEMPTS attempts"
              exit 1
            fi
          done
          
          echo "âœ… Latest release: $TAG_NAME"
          echo "âœ… Commit SHA: $COMMIT_SHA"
          
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "commit_sha=$COMMIT_SHA" >> "$GITHUB_OUTPUT"

      - name: Get current SHA reference
        id: current-sha
        run: |
          CURRENT_SHA=$(grep -ohP 'speakeasy-api/sdk-generation-action/[^@]+@\K[a-f0-9]{40}' .github/workflows/*.yaml | head -1)
          
          if [ -z "$CURRENT_SHA" ]; then
            echo "âŒ Error: Could not find current speakeasy-api/sdk-generation-action SHA reference"
            exit 1
          fi
          
          echo "Current SHA: $CURRENT_SHA"
          echo "sha=$CURRENT_SHA" >> "$GITHUB_OUTPUT"

      - name: Check if update is needed
        id: check-update
        run: |
          CURRENT="${{ steps.current-sha.outputs.sha }}"
          LATEST="${{ steps.latest-release.outputs.commit_sha }}"
          
          if [ "$CURRENT" = "$LATEST" ]; then
            echo "âœ… sdk-generation-action is already up to date ($CURRENT)"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "ðŸ“¦ Update needed: $CURRENT -> $LATEST"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update workflow files
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          CURRENT_SHA="${{ steps.current-sha.outputs.sha }}"
          NEW_SHA="${{ steps.latest-release.outputs.commit_sha }}"
          
          echo "Replacing SHA references in workflow files..."
          
          FILES_UPDATED=0
          for file in .github/workflows/*.yaml .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              if grep -q "speakeasy-api/sdk-generation-action.*@${CURRENT_SHA}" "$file"; then
                sed -i "s|speakeasy-api/sdk-generation-action/\([^@]*\)@${CURRENT_SHA}|speakeasy-api/sdk-generation-action/\1@${NEW_SHA}|g" "$file"
                echo "âœ… Updated: $file"
                FILES_UPDATED=$((FILES_UPDATED + 1))
              fi
            fi
          done
          
          echo "ðŸ“ Total files updated: $FILES_UPDATED"
          echo "files_updated=$FILES_UPDATED" >> "$GITHUB_ENV"

      - name: Verify changes
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          NEW_SHA="${{ steps.latest-release.outputs.commit_sha }}"
          
          echo "Verifying SHA updates..."
          
          REMAINING=$(grep -r "speakeasy-api/sdk-generation-action.*@${{ steps.current-sha.outputs.sha }}" .github/workflows/ 2>/dev/null || true)
          
          if [ -n "$REMAINING" ]; then
            echo "âš ï¸ Warning: Some references were not updated:"
            echo "$REMAINING"
          else
            echo "âœ… All references successfully updated to $NEW_SHA"
          fi
          
          echo ""
          echo "Updated references:"
          grep -r "speakeasy-api/sdk-generation-action.*@${NEW_SHA}" .github/workflows/ || true

      - name: Create pull request with changes
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          git config user.name "SyncUpBot"
          git config user.email "syncupbot@users.noreply.github.com"
          
          TAG_NAME="${{ steps.latest-release.outputs.tag_name }}"
          NEW_SHA="${{ steps.latest-release.outputs.commit_sha }}"
          CURRENT_SHA="${{ steps.current-sha.outputs.sha }}"
          
          SAFE_TAG=$(echo "$TAG_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          BRANCH_NAME="update-gh-action-${SAFE_TAG}"
          
          git checkout -b "$BRANCH_NAME"
          
          git add .github/workflows/
          
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="chore: update speakeasy-api/sdk-generation-action to ${TAG_NAME}"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          git push origin "$BRANCH_NAME"
          
          PR_BODY="## Summary
          
          Updates \`speakeasy-api/sdk-generation-action\` SHA reference to the latest release.
          
          - **Previous SHA:** \`${CURRENT_SHA}\`
          - **New SHA:** \`${NEW_SHA}\`
          - **Release:** [${TAG_NAME}](https://github.com/speakeasy-api/sdk-generation-action/releases/tag/${TAG_NAME})
          
          ### Files Updated
          
          $(git diff --name-only HEAD~1)
          
          ---
          *This PR was automatically created by the Update GH Action workflow.*"
          
          gh pr create \
            --title "Update speakeasy-api/sdk-generation-action to ${TAG_NAME}" \
            --body "$PR_BODY" \
            --head "$BRANCH_NAME" \
            --base main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          if [ "${{ steps.check-update.outputs.needs_update }}" = "true" ]; then
            {
              echo "## SDK Generation Action Update Summary"
              echo ""
              echo "### Pull Request Created"
              echo "- **Previous SHA:** \`${{ steps.current-sha.outputs.sha }}\`"
              echo "- **New SHA:** \`${{ steps.latest-release.outputs.commit_sha }}\`"
              echo "- **Release Tag:** ${{ steps.latest-release.outputs.tag_name }}"
              echo "- **Branch:** \`update-gh-action-${{ steps.latest-release.outputs.tag_name }}\`"
              echo ""
              echo "A pull request has been created with the SHA update. Please review and merge it to apply the changes."
              echo ""
              echo "[View latest sdk-generation-action release](https://github.com/speakeasy-api/sdk-generation-action/releases/tag/${{ steps.latest-release.outputs.tag_name }})"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            {
              echo "## SDK Generation Action Update Summary"
              echo ""
              echo "### No Update Needed"
              echo "- **Current SHA:** \`${{ steps.current-sha.outputs.sha }}\`"
              echo "- **Latest SHA:** \`${{ steps.latest-release.outputs.commit_sha }}\`"
              echo ""
              echo "The sdk-generation-action SHA reference is already up to date!"
            } >> "$GITHUB_STEP_SUMMARY"
          fi
